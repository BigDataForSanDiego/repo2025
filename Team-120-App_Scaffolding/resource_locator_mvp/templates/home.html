{% extends 'base.html' %}

{% block title %}Find Resources - Resource Locator{% endblock %}

{% block content %}
<div class="home-container" x-data="resourceMap()">
    <div class="filters-panel">
        <h2>Find Resources</h2>
        
        <!-- Location Input -->
        <div class="filter-group">
            <label>Your Location</label>
            <button @click="getUserLocation()" class="btn-secondary">Use My Location</button>
            <input type="text" 
                   x-model="userAddress" 
                   placeholder="Or enter address"
                   class="input-text">
        </div>
        
        <!-- Resource Type Filter -->
        <div class="filter-group">
            <label>Resource Type</label>
            <div class="filter-chips">
                <template x-for="type in resourceTypes" :key="type.value">
                    <button 
                        @click="toggleType(type.value)"
                        :class="{'active': selectedTypes.includes(type.value)}"
                        class="chip"
                        x-text="type.label">
                    </button>
                </template>
            </div>
        </div>
        
        <!-- Open Now Filter -->
        <div class="filter-group">
            <label class="checkbox-label">
                <input type="checkbox" x-model="openNow" @change="updateFilters()">
                Show only open now
            </label>
        </div>
        
        <!-- Distance Filter -->
        <div class="filter-group">
            <label>Distance</label>
            <select x-model="radiusMiles" @change="updateFilters()" class="input-select">
                <option value="1">1 mile</option>
                <option value="3">3 miles</option>
                <option value="5" selected>5 miles</option>
                <option value="10">10 miles</option>
            </select>
        </div>
        
        <button @click="updateFilters()" class="btn-primary">Search</button>
        
        <!-- Results Count -->
        <div class="results-info" x-show="resources.length > 0">
            <p><strong x-text="resources.length"></strong> resources found</p>
        </div>
        
        <!-- Results List -->
        <div class="results-list">
            <template x-for="resource in resources" :key="resource.id">
                <div class="resource-card" @click="selectResource(resource)">
                    <h3 x-text="resource.properties.name"></h3>
                    <p class="resource-type" x-text="resource.properties.rtype"></p>
                    <p class="resource-address" x-text="resource.properties.address"></p>
                    <span x-show="resource.properties.is_open_now === true" 
                          class="badge badge-open">Open Now</span>
                    <span x-show="resource.properties.is_open_now === false" 
                          class="badge badge-closed">Closed</span>
                </div>
            </template>
            <div x-show="resources.length === 0 && !loading" class="empty-state">
                <p>No resources found. Try adjusting your filters.</p>
            </div>
            <div x-show="loading" class="loading">
                <p>Loading resources...</p>
            </div>
        </div>
    </div>
    
    <div class="map-panel">
        <div id="map"></div>
    </div>
    
    <!-- Resource Detail Modal -->
    <div x-show="selectedResource" 
         x-cloak
         class="modal"
         @click.self="selectedResource = null">
        <div class="modal-content" x-show="selectedResource">
            <button class="modal-close" @click="selectedResource = null">&times;</button>
            <template x-if="selectedResource">
                <div>
                    <h2 x-text="selectedResource.properties.name"></h2>
                    <p class="resource-type-large" x-text="selectedResource.properties.rtype"></p>
                    
                    <div class="resource-details">
                        <p x-show="selectedResource.properties.description" 
                           x-text="selectedResource.properties.description"></p>
                        
                        <div class="contact-info">
                            <p x-show="selectedResource.properties.address">
                                <strong>Address:</strong>
                                <a :href="'https://www.google.com/maps/dir/?api=1&destination=' + 
                                         selectedResource.geometry.coordinates[1] + ',' + 
                                         selectedResource.geometry.coordinates[0]"
                                   target="_blank"
                                   x-text="selectedResource.properties.address"></a>
                            </p>
                            
                            <p x-show="selectedResource.properties.phone">
                                <strong>Phone:</strong>
                                <a :href="'tel:' + selectedResource.properties.phone" 
                                   x-text="selectedResource.properties.phone"></a>
                            </p>
                            
                            <p x-show="selectedResource.properties.email">
                                <strong>Email:</strong>
                                <a :href="'mailto:' + selectedResource.properties.email" 
                                   x-text="selectedResource.properties.email"></a>
                            </p>
                            
                            <p x-show="selectedResource.properties.website">
                                <strong>Website:</strong>
                                <a :href="selectedResource.properties.website" 
                                   target="_blank">Visit Website</a>
                            </p>
                        </div>
                        
                        <div x-show="selectedResource.properties.is_open_now !== null" class="open-status">
                            <span x-show="selectedResource.properties.is_open_now" 
                                  class="badge badge-open-large">Open Now</span>
                            <span x-show="!selectedResource.properties.is_open_now" 
                                  class="badge badge-closed-large">Closed</span>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<!-- Leaflet MarkerCluster JS -->
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script src="/static/js/map.js"></script>
{% endblock %}
